name: CI/CD Auto Pull and Rebuild
# hello
on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  deploy-rapip:
    runs-on: [rapip]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set project path
        run: |
          PROJECT_PATH=$(find /home -name 'icecream-app' -type d 2>/dev/null | head -1)
          if [ -z "$PROJECT_PATH" ]; then
            echo "‚ùå Folder icecream-app tidak ditemukan"
            exit 1
          fi
          echo "PROJECT_PATH=$PROJECT_PATH" >> $GITHUB_ENV
          echo "üìÅ Project path: $PROJECT_PATH"

      - name: Fix local repo by fresh clone
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          cd ${{ env.PROJECT_PATH }}
          rm -rf .git
          git init
          git remote add origin https://github.com/RafifAedra/ice_cream_app.git
          git fetch origin master
          git checkout -f master

      - name: Pull latest changes
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          git fetch origin master
          git reset --hard origin/master

      - name: Build and start containers
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          sudo docker compose build --no-cache
          sudo docker compose up -d

      - name: Wait for services to be ready
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          sleep 30
          sudo docker compose ps

      - name: Health check
        run: curl -f http://localhost:80 || exit 1
